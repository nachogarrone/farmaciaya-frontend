<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html class="full">

    <head>
        <title>FarmaciaYa</title>
        <meta charset="UTF-8">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="js/js.cookie.js"></script>
        <script src="js/purl.js"></script>
        <script type="text/javascript">
        (function() {
            var token = Cookies.get('token');
            if (typeof token == 'undefined') {
                window.location = "login.html";
            }
    
            // get location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                //x.innerHTML = "Geolocation is not supported by this browser.";
            }
    
    
            $.getJSON("http://localhost:8080/medicamento/get/" + $.url().param('id') + "?auth_token=" + Cookies.get('token'), function(result) {
                $("#subtitleMed").html("Farmacias que disponen " + result.data.nombre + " en stock.");
                $.each(result.data.farmacias, function(i, field) {
                    $("#farmaciasTable tbody").append("<tr><td>" + field.nombre + "</td><td>" + field.direccion + "</td><td>" + field.telefono + "</td></tr>");
                });
            });
        })();
    
        function showPosition(position) {
            var x = document.getElementById("demo");
            x.innerHTML = "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude;
        }
        </script>
        <link href="css/style.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">


    </head>

    <body>









        <div class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">FarmaciaYa</a>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav pull-right">
                        <li><a href="login.html" /><i class="fa fa-user"></i> Iniciar Session</a>
                        </li>
                        <li><a href="register.html" /><i class="fa fa-user-plus"></i> Registrarme</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>




        <div class="container-fluid" id="main">

            <div class="row">
                <!--  <div class="container">-->
                <div class="col-xs-8" id="left">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <p id="demo"></p>
                            <h1 align="center">  Farmacias cercanas </h1>
                            <p align="center" id="subtitleMed"> Farmacias que disponen en stock </p>
                            <form accept-charset="UTF-8" role="form" class="form-signin">
                                <fieldset>
                                    <label class="panel-home">
                                    </label>
                                </fieldset>
                            </form>
                        </div>
                        <div class="panel-heading">
                            <div class="row-fluid user-row">
                                <table class="table" id="farmaciasTable">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Direccion</th>
                                            <th>Telefono</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="google-maps" >
            <div id="map" ></div>
        </div>


        <script>

            function initMap() {
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: -34.888637, lng: -56.159218},
                    zoom: 13
                });

                var geocoder = new google.maps.Geocoder();
                geocodePharmacyAddress(geocoder, map);



                var infoWindow = new google.maps.InfoWindow({map: map});

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        var marker = new google.maps.Marker({
                            map: map,
                            position: pos,
                            animation: google.maps.Animation.DROP,
                            //    title: 'Usted se encuentra aquí.'
                        });

                        map.setZoom(14);
                        //   infoWindow.setPosition(pos);
                        //  infoWindow.setContent('Usted se encuentra aquí.');
                        map.setCenter(pos);
                        var cityCircle = new google.maps.Circle({
                            strokeColor: '#FF0000',
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: '#FF0000',
                            fillOpacity: 0.35,
                            map: map,
                            center: map.getCenter(),
                            radius: 2000
                        });
                    }, function () {
                        handleLocationError(true, infoWindow, map.getCenter());
                    });
                } else {
                    // Browser doesn't support Geolocation
                    handleLocationError(false, infoWindow, map.getCenter());
                }
            }

            function geocodePharmacyAddress(geocoder, resultsMap) {
                var image = {
                    url: 'img/pharmacy.ico',
                    size: new google.maps.Size(30, 32),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(0, 32)
                };
                var shape = {
                    coords: [1, 1, 1, 20, 18, 20, 18, 1],
                    type: 'poly'
                };


                //Formato del array, direccion+",Montevideo,Uruguay" , Farmacia, Numero de telefono
                //Aca se podria seleccionar si mostrar por barrios o no.
                var addressPharmacys = [['DR. ISIDRO MAS DE AYALA 5359, ESQ.DR. ARTUCIO', 'Fcia. ESTEFANIA (MIGHTY S.A)', '2215-4550 / 2215-2716 / 2211-4209'],
                    ['JUAN BENITO BLANCO 3351, ESQ. PEREYRA DE LA LUZ, Montevideo, Uruguay', 'Fcia. EL TÃšNEL', '2622-3828']];

                var address;
                var titlePharmacy;
                for (i = 0; i < addressPharmacys.length; i++) {
                    address = addressPharmacys[i][0] + ",Montevideo,Uruguay";
                    titlePharmacy = addressPharmacys[i][1] + "Telefono:" + addressPharmacys[i][2];



                    geocoder.geocode({'address': address}, function (results, status) {
                        if (status === google.maps.GeocoderStatus.OK) {
                            //  resultsMap.setCenter(results[0].geometry.location);
                            var marker = new google.maps.Marker({
                                map: resultsMap,
                                icon: image,
                                title: titlePharmacy,
                                shape: shape,
                                position: results[0].geometry.location,
                            });
                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);
                        }
                    });
                }

            }
            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPosition(pos);
                infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
            }

        </script>

        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBrQStpGDwRAB8L7oz6x_N009365gA50Q&signed_in=true&callback=initMap"
                async defer>
        </script>  

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>




    </body>

</html>
